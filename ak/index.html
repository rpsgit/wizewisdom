<script>
// IMPORTANT: Update this BASE URL every time you do a "New Deployment"
const BASE = "https://script.google.com/macros/s/AKfycbwWOk7xNyjR8jS1UWuzp-BmUNnVEXI-6Db7Cr1iRC0ziqTm01jcSpF-XakD2l5PWcfDNA/exec";
const MENU_URL = BASE + "?func=getMenu";
const SETTINGS_URL = BASE + "?func=getSettings";

const prices = {};
let settings = {};
let pending = null;
const k = t => t.toLowerCase().replace(/\s+/g,"_");

fetch(SETTINGS_URL).then(r=>r.json()).then(s=>{
  settings = s;
  if (s.closed_today || s.auto_closed){
    document.getElementById('closedBanner').style.display="block";
    document.getElementById('form').style.display="none";
    document.getElementById('cart').style.display="none";
  }
});

function loadMenu(){
  fetch(MENU_URL).then(r=>r.json()).then(data=>{
    const tabs = document.getElementById('tabs'), menu = document.getElementById('menu'), cats={};
    data.forEach(i=>{
      const c=i.Category||"Others";
      cats[c]=cats[c]||[];
      cats[c].push(i);
    });
    let first=true;
    Object.keys(cats).forEach(cat=>{
      const id=k(cat);
      tabs.insertAdjacentHTML("beforeend", `<button type="button" class="${first?'active':''}" onclick="openTab('${id}',this)">${cat}</button>`);
      menu.insertAdjacentHTML("beforeend",`
        <div class="tab-content ${first?'active':''}" id="${id}">
          <div class="grid">${cats[cat].map(i=>{
            const key=k(i.Item); prices[key]=i.Price;
            return `<div class="item">
              <img src="${i.ImageURL || 'https://via.placeholder.com/300x200'}" onclick="viewImage(this.src)">
              <div class="body">
                <div><strong>${i.Item}</strong><div class="price">₱${i.Price}</div></div>
                <div class="actions">
                  ${i.SoldOut ? '<div class="soldout">SOLD OUT</div>' : 
                  `<input type="checkbox" name="i_${key}" class="item-check">
                   <input type="number" name="q_${key}" value="1" min="1" style="display:none" class="item-qty">`}
                </div>
              </div>
            </div>`;
          }).join("")}</div>
        </div>`);
      first=false;
    });
  });
}

function getCartState() {
  let total = 0, count = 0;
  const items = [], itemStrings = [];
  document.querySelectorAll('.item-check').forEach(cb => {
    const key = cb.name.replace("i_", ""), qtyInput = document.querySelector(`input[name="q_${key}"]`);
    if (cb.checked) {
      qtyInput.style.display = "block";
      const qty = parseInt(qtyInput.value) || 1;
      total += (prices[key] * qty); count += qty;
      items.push({ name: key.replace(/_/g, " ").toUpperCase(), qty, subtotal: prices[key]*qty });
      itemStrings.push(`${key.replace(/_/g, " ")} (x${qty})`);
    } else qtyInput.style.display = "none";
  });
  return { total, count, items, itemStrings };
}

function updateCartUI() {
  const s = getCartState();
  document.getElementById('totalDisplay').textContent = `Total: ₱${s.total}`;
  document.getElementById('cartSum').textContent = s.total;
  document.getElementById('cartCount').textContent = s.count;
}

function showSummary() {
  const s = getCartState();
  if (s.count === 0) return alert("Cart is empty!");
  let html = s.items.map(i => `<div class="summary-item"><span>${i.name} x${i.qty}</span><span>₱${i.subtotal}</span></div>`).join("");
  const pay = document.querySelector('input[name="payment"]:checked').value;
  html += `<div class="summary-item" style="color:gray"><span>Method:</span><span>${pay}</span></div>`;
  html += `<div class="summary-total">TOTAL: ₱${s.total}</div>`;
  document.getElementById('preview').innerHTML = html;
  pending = { items: s.itemStrings, total: s.total, payment: pay };
  document.getElementById('modal').style.display = "flex";
}

document.addEventListener("change", (e) => { if (e.target.matches('.item-check, .item-qty')) updateCartUI(); });
document.getElementById('cart').onclick = () => showSummary();
document.getElementById('form').onsubmit = (e) => { e.preventDefault(); showSummary(); };

async function confirmOrder(){
  const name = document.getElementById('userName').value.trim();
  const contact = document.getElementById('userContact').value.trim();
  const address = document.getElementById('userAddress').value.trim();

  if (!name || !contact || !address) {
    alert("Please complete Delivery Details first!");
    document.getElementById('modal').style.display = "none";
    return;
  }

  const btn = document.getElementById('finalBtn');
  btn.disabled = true; btn.textContent = "SENDING...";

  const params = new URLSearchParams({
    func: "order", name, contact, address,
    notes: document.querySelector('textarea[name="notes"]').value,
    payment: pending.payment,
    items: pending.items.join(", "),
    total: pending.total
  });

  // Saving to Backend
  try {
    await fetch(BASE, { method: "POST", mode: "no-cors", body: params });
    const id = "AK-" + Math.floor(Date.now() / 1000).toString().slice(-6);
    document.getElementById('modalContent').innerHTML = `
      <h2>ORDER PLACED!</h2><p>Ref ID: <span class="order-id-display">${id}</span></p>
      <button class="main" onclick="location.reload()">OK</button>`;
  } catch (e) {
    alert("Error saving order. Check your connection.");
    btn.disabled = false; btn.textContent = "CONFIRM & SEND";
  }
}

function togglePay(){
  const val = document.querySelector('input[name="payment"]:checked').value;
  const inst = document.getElementById('payInstructions');
  inst.style.display = val === "Cash" ? "none" : "block";
  if(val !== "Cash") {
    document.getElementById('payLabel').textContent = val;
    document.getElementById('payNum').textContent = val === "GCash" ? settings.gcash_number : settings.maya_number;
  }
}

loadMenu();
</script>
