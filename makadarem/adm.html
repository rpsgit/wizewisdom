--- 
layout: default 
title: MFC ADMIN PANEL 
--- 

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet"> 

<style> 
:root { --mfc-gold: #c5a059; --mfc-dark: #1a1a1a; --mfc-bg: #f4f4f4; --mfc-white: #ffffff; } 
body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--mfc-bg); color: var(--mfc-dark); } 
h1, h2, th { font-family: 'Playfair Display', serif; } 
.page { max-width: 1300px; margin: 20px auto; padding: 40px; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); } 
h1 { text-align: center; border-bottom: 2px solid var(--mfc-gold); padding-bottom: 10px; } 
.settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; background: #fafafa; padding: 25px; border-radius: 8px; margin-bottom: 30px; } 
.settings-grid label { display: block; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; color: #666; } 
.settings-grid input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; } 
button { background: var(--mfc-dark); color: white; border: none; padding: 12px 20px; cursor: pointer; font-weight: 600; text-transform: uppercase; border-radius: 4px; transition: 0.3s; } 
button:hover { background: var(--mfc-gold); } 
.table-container { overflow-x: auto; margin-top: 20px; } 
table { width: 100%; border-collapse: collapse; } 
th { text-align: left; padding: 15px; border-bottom: 2px solid var(--mfc-gold); background: #f8f8f8; font-size: 0.85rem; } 
td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: top; } 
.status-open { color: #27ae60; background: #eafaf1; padding: 8px 15px; border-radius: 4px; font-weight: bold; } 
.status-closed { color: #e74c3c; background: #fdedec; padding: 8px 15px; border-radius: 4px; font-weight: bold; } 
.menu-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat'; } 
.completed-row { background: #f2f2f2; opacity: 0.6; } 
.cancelled-row { background: #fdedec; opacity: 0.6; } 
.unpaid-delivered-row { background: #fff9c4 !important; border-left: 5px solid #fbc02d; } 
.details-text { font-size: 0.8rem; line-height: 1.4; color: #444; } 
.note-tag { color: var(--mfc-gold); font-style: italic; display: block; margin-top: 5px; font-weight: 600; } 
.payment-tag { font-weight: 600; color: #1a1a1a; display: block; margin-bottom: 5px; text-transform: uppercase; font-size: 0.75rem; } 
.order-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } 
.btn-save-orders { background: var(--mfc-gold); font-size: 0.8rem; } 
.paid-badge { color: #27ae60; font-weight: bold; font-size: 0.75rem; border: 1px solid #27ae60; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; } 
/* New Style for the Total Amount display */
.total-label { display: block; font-weight: 600; color: var(--mfc-gold); margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px dashed #ddd; padding-bottom: 4px; }
</style> 

<div class="page"> 
  <h1>MFC ADMIN CONTROL</h1> 

  <div style="text-align: center; margin: 30px 0;"> 
    <button id="toggleStore" onclick="toggleStoreStatus()">SYNCING...</button> 
    <div id="storeStatus" style="margin-top:10px;">LOADING...</div> 
  </div> 

  <h2>Store Settings</h2> 
  <div class="settings-grid"> 
    <div> 
      <label>GCash Number</label><input type="text" id="gcashNum"> 
      <label>Maya Number</label><input type="text" id="mayaNum"> 
    </div> 
    <div> 
      <label>Admin Email</label><input type="email" id="adminEmail"> 
      <label>Messenger Link</label><input type="text" id="messengerLink"> 
    </div> 
    <div> 
      <label>Pushover User Key</label><input type="password" id="pushUser"> 
      <label>Pushover API Token</label><input type="password" id="pushToken"> 
    </div> 
    <div> 
      <label>Telegram Token</label><input type="password" id="tgToken"> 
      <label>Telegram Chat ID</label><input type="text" id="tgChat"> 
    </div> 
    <div style="display:flex; align-items:flex-end; grid-column: 1 / -1;"> 
      <button onclick="saveSettingsInfo()" style="width:100%; background:var(--mfc-gold);">Update All System Settings</button> 
    </div> 
  </div> 

  <div class="order-header-flex"> 
    <h2>Live Orders</h2> 
    <button onclick="saveAllOrderStatuses()" class="btn-save-orders" id="saveOrdersBtn">Save Order Changes</button> 
  </div> 

  <div class="table-container"> 
    <table> 
      <thead> 
        <tr> 
          <th style="width: 12%;">ID / Date</th> 
          <th style="width: 15%;">Customer</th> 
          <th style="width: 20%;">Items</th> 
          <th style="width: 25%;">Address, Notes & Payment</th> 
          <th style="width: 8%; text-align:center;">Paid</th> 
          <th style="width: 20%;">Update Status</th> 
        </tr> 
      </thead> 
      <tbody id="ordersBody"></tbody> 
    </table> 
  </div> 

  <h2>Inventory Management</h2> 
  <div class="table-container"> 
    <table> 
      <thead><tr><th>Item</th><th>Category</th><th>Price</th><th style="text-align:center;">Sold Out</th><th>Action</th></tr></thead> 
      <tbody id="menuBody"></tbody> 
    </table> 
  </div> 
</div> 

<script> 
const BASE = "https://script.google.com/macros/s/AKfycbxpkVursbR5CH-6Ko5MHaujepVGGnum12-mtO-qnqvpHNUnYi0DMJpc2RZGcjo-TQf3/exec"; 
let isDirty = false;

async function apiPost(params) { 
  try { 
    // We use a URLSearchParams approach for compatibility
    await fetch(BASE, { 
      method: "POST", mode: "no-cors", 
      headers: { "Content-Type": "application/x-www-form-urlencoded" }, 
      body: new URLSearchParams(params).toString() 
    }); 
    return true; 
  } catch (e) { return false; } 
} 

// ... (loadSettings, saveSettingsInfo, toggleStoreStatus, loadMenu, saveMenuRow remain the same) ...

function markRowModified(el) {
    isDirty = true;
    // Add a visual indicator and a class we can select later
    const row = el.closest('tr');
    row.classList.add('is-modified');
    row.style.borderLeft = "5px solid var(--mfc-gold)"; 
}

function loadOrders() { 
  if (isDirty) return; 

  fetch(BASE + "?func=getOrders").then(r => r.json()).then(data => { 
    const ob = document.getElementById('ordersBody'); 
    if (!data || !data.length) { ob.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No orders found.</td></tr>"; return; } 
      
    const stages = ["Order Placed", "Order Received", "Cooking", "Packing", "Delivering", "Delivered", "Cancelled"]; 
      
    ob.innerHTML = [...data].reverse().map(o => { 
      const currentStatus = o['Order Status'] || o.Status || "Order Placed"; 
      const isDelivered = currentStatus === 'Delivered'; 
      const isCancelled = currentStatus === 'Cancelled'; 
      const isPaid = (o.Paid === "PAID" || o.paid === "PAID"); 
      const isInactive = isDelivered || isCancelled; 
        
      let options = stages.map(s => `<option value="${s}" ${currentStatus === s ? 'selected' : ''}>${s}</option>`).join(''); 
      
      let rowClass = ''; 
      if (isDelivered && !isPaid) { rowClass = 'unpaid-delivered-row'; } 
      else if (isDelivered) { rowClass = 'completed-row'; } 
      else if (isCancelled) { rowClass = 'cancelled-row'; } 
        
      const itemList = o.Items ? o.Items.split(',').map((item, index) => `${index + 1}. ${item.trim()}`).join('<br>') : ''; 
      const payDisplay = o['Payment Method'] || o.Payment || o.payment || ''; 
      const notesDisplay = o.Notes || o.notes || ''; 
      const addressDisplay = o.Address || o.address || '';
      const orderTotal = o.Total || o['Order Total'] || o.total || '';

      return ` 
        <tr class="${rowClass}"> 
          <td> 
            <small>${o.Timestamp ? new Date(o.Timestamp).toLocaleDateString() : ''}</small><br><strong>${o.OrderID || o['Order ID']}</strong> 
            ${isPaid ? '<br><span class="paid-badge">PAID</span>' : ''} 
          </td> 
          <td><strong>${o.Name}</strong><br><small>${o.Contact || ''}</small></td> 
          <td class="details-text">
            ${orderTotal ? `<span class="total-label">TOTAL: â‚±${orderTotal}</span>` : ''}
            ${itemList}
          </td> 
          <td class="details-text"> 
            ${payDisplay ? `<span class="payment-tag">ðŸ’³ ${payDisplay}</span>` : ''} 
            <div style="margin-bottom:5px; color:#333;">${addressDisplay}</div> 
            ${notesDisplay ? `<span class="note-tag">Note: ${notesDisplay}</span>` : ''} 
          </td> 
          <td style="text-align:center;"> 
             <input type="checkbox" class="paid-toggle" onchange="markRowModified(this)" data-id="${o.OrderID || o['Order ID']}" ${isPaid ? 'checked' : ''}> 
          </td> 
          <td> 
             <select class="menu-input status-select" onchange="markRowModified(this)" data-id="${o.OrderID || o['Order ID']}" ${isInactive ? 'disabled' : ''}> 
              ${options} 
            </select> 
          </td> 
        </tr> 
      `; 
    }).join(''); 
  }); 
} 

async function saveAllOrderStatuses() { 
  const btn = document.getElementById('saveOrdersBtn'); 
  // OPTIMIZATION: Only select rows that were actually modified
  const modifiedRows = document.querySelectorAll('.is-modified'); 
  
  if (modifiedRows.length === 0) {
      alert("No changes to save!");
      return;
  }
  
  const originalText = btn.textContent; 
  btn.disabled = true; 
  btn.textContent = `SAVING ${modifiedRows.length} CHANGES...`; 
  
  // We process only the rows that changed
  const promises = Array.from(modifiedRows).map(row => { 
    const sel = row.querySelector('.status-select');
    const orderId = sel.getAttribute('data-id'); 
    const paidBox = row.querySelector('.paid-toggle'); 
    
    return apiPost({  
      func: "markCompleted",  
      id: orderId,  
      status: sel.value, 
      paid: String(paidBox.checked) 
    }); 
  }); 
  
  await Promise.all(promises); 
  btn.textContent = "CHANGES SAVED!"; 
  isDirty = false; 

  setTimeout(() => {  
    btn.disabled = false; btn.textContent = originalText; 
    loadOrders();  
  }, 1500); 
} 

loadSettings(); loadMenu(); loadOrders(); 
setInterval(loadOrders, 30000); 
</script>
