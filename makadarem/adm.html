---
layout: default
title: MFC ADMIN PANEL
---

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

<style>
:root { --mfc-gold: #c5a059; --mfc-dark: #1a1a1a; --mfc-bg: #f4f4f4; --mfc-white: #ffffff; }
body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--mfc-bg); color: var(--mfc-dark); }
h1, h2, th { font-family: 'Playfair Display', serif; }

/* Login Overlay Styles */
#loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--mfc-dark); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
.login-box { background: #fff; padding: 40px; border-radius: 8px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-top: 5px solid var(--mfc-gold); }
.login-box h2 { margin-top: 0; color: var(--mfc-dark); }
.login-box input { width: 100%; padding: 15px; margin: 20px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; text-align: center; }
.err-msg { color: #e74c3c; font-size: 0.85rem; display: none; margin-bottom: 10px; font-weight: bold; }

/* Main Page Styles */
.page { max-width: 1300px; margin: 20px auto; padding: 40px; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: none; /* Hidden by default */ }
h1 { text-align: center; border-bottom: 2px solid var(--mfc-gold); padding-bottom: 10px; }
.settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; background: #fafafa; padding: 25px; border-radius: 8px; margin-bottom: 30px; }
.settings-grid label { display: block; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; color: #666; }
.settings-grid input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; }
button { background: var(--mfc-dark); color: white; border: none; padding: 12px 20px; cursor: pointer; font-weight: 600; text-transform: uppercase; border-radius: 4px; transition: 0.3s; }
button:hover { background: var(--mfc-gold); }
.table-container { overflow-x: auto; margin-top: 20px; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 15px; border-bottom: 2px solid var(--mfc-gold); background: #f8f8f8; font-size: 0.85rem; }
td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: top; }
.status-open { color: #27ae60; background: #eafaf1; padding: 8px 15px; border-radius: 4px; font-weight: bold; }
.status-closed { color: #e74c3c; background: #fdedec; padding: 8px 15px; border-radius: 4px; font-weight: bold; }
.menu-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat'; }
.completed-row { background: #f2f2f2; opacity: 0.6; }
.cancelled-row { background: #fdedec; opacity: 0.6; }
.details-text { font-size: 0.8rem; line-height: 1.4; color: #444; }
.note-tag { color: var(--mfc-gold); font-style: italic; display: block; margin-top: 5px; font-weight: 600; }
.payment-tag { font-weight: 600; color: #1a1a1a; display: block; margin-bottom: 5px; text-transform: uppercase; font-size: 0.75rem; }
.order-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.btn-save-orders { background: var(--mfc-gold); font-size: 0.8rem; }
.paid-badge { color: #27ae60; font-weight: bold; font-size: 0.75rem; border: 1px solid #27ae60; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; }
</style>

<div id="loginOverlay">
  <div class="login-box">
    <h2>ADMIN ACCESS</h2>
    <p style="font-size:0.9rem; color:#666;">Enter password to access control panel.</p>
    <div id="loginError" class="err-msg">Incorrect Password</div>
    <input type="password" id="adminPasswordInput" placeholder="Enter Password" onkeypress="if(event.key==='Enter') verifyPassword()">
    <button onclick="verifyPassword()" id="loginBtn" style="width:100%;">LOGIN</button>
  </div>
</div>

<div class="page" id="mainDashboard">
  <h1>MFC ADMIN CONTROL</h1>

  <div style="text-align: center; margin: 30px 0;">
    <button id="toggleStore" onclick="toggleStoreStatus()">SYNCING...</button>
    <div id="storeStatus" style="margin-top:10px;">LOADING...</div>
  </div>

  <h2>Store Settings</h2>
  <div class="settings-grid">
    <div>
      <label>GCash Number</label><input type="text" id="gcashNum">
      <label>Maya Number</label><input type="text" id="mayaNum">
    </div>
    <div>
      <label>Admin Email</label><input type="email" id="adminEmail">
      <label>Messenger Link</label><input type="text" id="messengerLink">
    </div>
    <div>
      <label>Pushover User Key</label><input type="password" id="pushUser">
      <label>Pushover API Token</label><input type="password" id="pushToken">
    </div>
    <div>
      <label>Telegram Token</label><input type="password" id="tgToken">
      <label>Telegram Chat ID</label><input type="text" id="tgChat">
    </div>
    <div style="display:flex; align-items:flex-end; grid-column: 1 / -1;">
      <button onclick="saveSettingsInfo()" style="width:100%; background:var(--mfc-gold);">Update All System Settings</button>
    </div>
  </div>

  <div class="order-header-flex">
    <h2>Live Orders</h2>
    <button onclick="saveAllOrderStatuses()" class="btn-save-orders" id="saveOrdersBtn">Save Order Changes</button>
  </div>
  
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width: 12%;">ID / Date</th>
          <th style="width: 15%;">Customer</th>
          <th style="width: 20%;">Items</th>
          <th style="width: 25%;">Address, Notes & Payment</th>
          <th style="width: 8%; text-align:center;">Paid</th>
          <th style="width: 20%;">Update Status</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

  <h2>Inventory Management</h2>
  <div class="table-container">
    <table>
      <thead><tr><th>Item</th><th>Category</th><th>Price</th><th style="text-align:center;">Sold Out</th><th>Action</th></tr></thead>
      <tbody id="menuBody"></tbody>
    </table>
  </div>
</div>

<script>
const BASE = "https://script.google.com/macros/s/AKfycbxpkVursbR5CH-6Ko5MHaujepVGGnum12-mtO-qnqvpHNUnYi0DMJpc2RZGcjo-TQf3/exec";
let globalSettings = {}; // Store settings globally after fetch

// --- LOGIN LOGIC (FIXED & ROBUST) ---
async function verifyPassword() {
  const input = document.getElementById('adminPasswordInput').value;
  const btn = document.getElementById('loginBtn');
  const err = document.getElementById('loginError');
  
  if(!input) return;
  
  btn.textContent = "VERIFYING...";
  err.style.display = 'none';

  try {
    // 1. Fetch data
    const response = await fetch(BASE + "?func=getSettings");
    const settings = await response.json();
    globalSettings = settings;

    // 2. Find the password key intelligently
    // This ignores case (Password vs password) and whitespace (password vs "password ")
    const keys = Object.keys(settings);
    const passwordKey = keys.find(key => key.toLowerCase().trim() === "password");

    if (!passwordKey) {
        alert("CRITICAL ERROR: 'password' row not found in Sheet.\nPlease check your Google Sheet Admin tab.");
        btn.textContent = "LOGIN";
        return;
    }

    // 3. Get value and FORCE convert to string for comparison
    const sheetPass = String(settings[passwordKey]).trim();
    const inputPass = input.trim();

    if (inputPass === sheetPass) {
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('mainDashboard').style.display = 'block';
      initializeDashboard(settings); 
    } else {
      btn.textContent = "LOGIN";
      err.style.display = 'block';
      err.textContent = "Incorrect Password";
    }
  } catch (e) {
    console.error(e);
    btn.textContent = "LOGIN";
    err.style.display = 'block';
    err.textContent = "Connection Error or Sheet Error.";
  }
}

function initializeDashboard(s) {
    populateSettingsUI(s);
    loadMenu(); 
    loadOrders();
    setInterval(loadOrders, 30000);
}

// --- CORE FUNCTIONS ---

async function apiPost(params) {
  try {
    await fetch(BASE, {
      method: "POST", mode: "no-cors",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(params).toString()
    });
    return true;
  } catch (e) { return false; }
}

function populateSettingsUI(s) {
    const closed = !!s.closed_today;
    const btn = document.getElementById('toggleStore');
    const status = document.getElementById('storeStatus');
    btn.textContent = closed ? "Open Kitchen" : "Close Kitchen";
    status.textContent = closed ? "KITCHEN IS CLOSED" : "KITCHEN IS OPEN & ACCEPTING ORDERS";
    status.className = closed ? "status-closed" : "status-open";
    document.getElementById('gcashNum').value = s.gcash_number || '';
    document.getElementById('mayaNum').value = s.maya_number || '';
    document.getElementById('adminEmail').value = s.notification_email || '';
    document.getElementById('messengerLink').value = s.messenger_link || '';
    document.getElementById('tgToken').value = s.telegram_token || '';
    document.getElementById('tgChat').value = s.telegram_chat_id || '';
    document.getElementById('pushUser').value = s.pushover_user_key || '';
    document.getElementById('pushToken').value = s.pushover_api_token || '';
}

async function saveSettingsInfo() {
  const btn = event.target;
  const original = btn.textContent;
  btn.textContent = "SYNCING...";
  await apiPost({
    func: "updatePaymentInfo",
    gcash_number: document.getElementById('gcashNum').value,
    maya_number: document.getElementById('mayaNum').value,
    notification_email: document.getElementById('adminEmail').value,
    messenger_link: document.getElementById('messengerLink').value,
    telegram_token: document.getElementById('tgToken').value,
    telegram_chat_id: document.getElementById('tgChat').value,
    pushover_user_key: document.getElementById('pushUser').value,
    pushover_api_token: document.getElementById('pushToken').value
  });
  btn.textContent = "SUCCESS!";
  setTimeout(() => { btn.textContent = original; }, 2000);
}

async function toggleStoreStatus() {
  const btn = document.getElementById('toggleStore');
  const currentState = (btn.textContent === "Close Kitchen");
  btn.disabled = true; btn.textContent = "...";
  await apiPost({ func: "toggleClose", status: String(currentState) });
  
  fetch(BASE + "?func=getSettings").then(r => r.json()).then(s => {
      populateSettingsUI(s);
      btn.disabled = false;
  });
}

function loadMenu() {
  fetch(BASE + "?func=getMenu").then(r => r.json()).then(data => {
    document.getElementById('menuBody').innerHTML = data.map(m => `
      <tr>
        <td><input type="text" class="menu-input" value="${m.Item}" id="name-${m.row}"></td>
        <td><input type="text" class="menu-input" value="${m.Category}" id="cat-${m.row}"></td>
        <td><input type="number" class="menu-input" value="${m.Price}" id="price-${m.row}"></td>
        <td style="text-align:center;"><input type="checkbox" id="sold-${m.row}" ${String(m.SoldOut)==='true'?'checked':''}></td>
        <td><button onclick="saveMenuRow(${m.row}, this)" style="padding:5px 10px; font-size:0.6rem;">UPDATE</button></td>
      </tr>
    `).join('');
  });
}

async function saveMenuRow(rowId, btn) {
  const original = btn.textContent; btn.textContent = "...";
  await apiPost({
    func: "updateMenuItem",
    row: rowId,
    item: document.getElementById(`name-${rowId}`).value,
    category: document.getElementById(`cat-${rowId}`).value,
    price: document.getElementById(`price-${rowId}`).value,
    soldOut: String(document.getElementById(`sold-${rowId}`).checked)
  });
  btn.textContent = "SAVED";
  setTimeout(() => { btn.textContent = original; }, 1000);
}

function loadOrders() {
  fetch(BASE + "?func=getOrders").then(r => r.json()).then(data => {
    const ob = document.getElementById('ordersBody');
    if (!data || !data.length) { ob.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No orders found.</td></tr>"; return; }
    
    const stages = ["Order Placed", "Order Received", "Cooking", "Packing", "Delivering", "Delivered", "Cancelled"];
    
    ob.innerHTML = [...data].reverse().map(o => {
      const isDelivered = o['Order Status'] === 'Delivered' || o.Status === 'Delivered';
      const isCancelled = o['Order Status'] === 'Cancelled' || o.Status === 'Cancelled';
      const isInactive = isDelivered || isCancelled;
      const isPaid = (o.Paid === "PAID" || o.paid === "PAID");
      
      const currentStatus = o['Order Status'] || o.Status || "Order Placed";
      let options = stages.map(s => `<option value="${s}" ${currentStatus === s ? 'selected' : ''}>${s}</option>`).join('');
      let rowClass = isDelivered ? 'completed-row' : (isCancelled ? 'cancelled-row' : '');
      
      const itemList = o.Items ? o.Items.split(',').map((item, index) => `${index + 1}. ${item.trim()}`).join('<br>') : '';
      
      // FIXED: Robust Search for Payment Method
      let payDisplay = 'N/A';
      
      // 1. Try explicit keys
      if (o['Payment Method']) payDisplay = o['Payment Method'];
      else if (o['PaymentMethod']) payDisplay = o['PaymentMethod'];
      else if (o.paymentMethod) payDisplay = o.paymentMethod;
      else if (o.Payment) payDisplay = o.Payment;
      else if (o.payment) payDisplay = o.payment;
      else if (o.MOP) payDisplay = o.MOP;
      else if (o['Mode of Payment']) payDisplay = o['Mode of Payment'];
      else {
          // 2. Fuzzy search for keys containing common payment words
          const lowerKeys = Object.keys(o);
          const match = lowerKeys.find(k => 
             k.toLowerCase().includes('payment') || 
             k.toLowerCase().includes('mop') || 
             k.toLowerCase().includes('mode') ||
             k.toLowerCase().includes('method')
          );
          if(match) payDisplay = o[match];
      }
      
      const notesDisplay = o.Notes || o.notes || '';

      return `
        <tr class="${rowClass}">
          <td>
            <small>${o.Timestamp ? new Date(o.Timestamp).toLocaleDateString() : 'N/A'}</small><br><strong>${o.OrderID || o['Order ID']}</strong>
            ${isPaid ? '<br><span class="paid-badge">PAID</span>' : ''}
          </td>
          <td><strong>${o.Name}</strong><br><small>${o.Contact || ''}</small></td>
          <td class="details-text">${itemList}</td>
          <td class="details-text">
            <span class="payment-tag">ðŸ’³ ${payDisplay}</span>
            <div style="margin-bottom:5px; color:#333;">${o.Address || ''}</div>
            ${notesDisplay ? `<span class="note-tag">Note: ${notesDisplay}</span>` : ''}
          </td>
          <td style="text-align:center;">
             <input type="checkbox" class="paid-toggle" data-id="${o.OrderID || o['Order ID']}" ${isPaid ? 'checked' : ''}>
          </td>
          <td>
            <select class="menu-input status-select" data-id="${o.OrderID || o['Order ID']}" ${isInactive ? 'disabled' : ''}>
              ${options}
            </select>
          </td>
        </tr>
      `;
    }).join('');
  });
}

async function saveAllOrderStatuses() {
  const btn = document.getElementById('saveOrdersBtn');
  const selects = document.querySelectorAll('.status-select');
  if (selects.length === 0) return;

  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "SAVING...";

  const promises = Array.from(selects).map(sel => {
    const orderId = sel.getAttribute('data-id');
    const paidBox = document.querySelector(`.paid-toggle[data-id="${orderId}"]`);
    return apiPost({ 
      func: "markCompleted", 
      id: orderId, 
      status: sel.value,
      paid: String(paidBox.checked)
    });
  });

  await Promise.all(promises);
  btn.textContent = "ALL SAVED!";
  setTimeout(() => { 
    btn.disabled = false; btn.textContent = originalText;
    loadOrders(); 
  }, 1500);
}
</script>
