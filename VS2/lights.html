<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VS2 Residential Lights Status</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    #tower-select { font-size: 16px; padding: 5px; margin-bottom: 20px; }
    .floor { margin-bottom: 30px; }
    .floor-name { font-weight: bold; margin-bottom: 5px; }
    .unit-grid { display: flex; flex-wrap: wrap; gap: 5px; }
    .unit-btn { width: 50px; height: 30px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; }
    .unit-btn.large { width: 70px; height: 40px; font-size: 14px; }
    .on { background-color: yellow; color: black; }
    .off { background-color: gray; }
    .spacer { width: 10px; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal.show { display:block; }
    .modal-content { background:#fff; margin:15% auto; padding:20px; width:320px; border-radius:10px; text-align:center; }
    #toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:5px; opacity:0; transition:opacity 0.5s; }
    #toast.show { opacity:1; }
  </style>
</head>
<body>

<h1 id="page-title">VS2 Residential Lights Status</h1>
<select id="tower-select">
  <option value="Tower A">Tower A</option>
  <option value="Tower B">Tower B</option>
</select>

<div id="building"></div>

<div id="modal" class="modal">
  <div class="modal-content">
    <p id="modal-text"></p>
    <button id="on-btn">OK</button>
    <button id="out-btn">OUT</button>
  </div>
</div>

<div id="toast"></div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzPSGwu1ATbhSgYuwgOfp794_Mhazoc-cg4o75fb__3wTpGNsQ_80XBQrGqTKcwUG7N/exec"; // replace with your Web App URL
const UNIT_COUNT = 61;
const FLOORS = [...Array(32).keys()].map(i => 14+i).concat("PH");

let lightData = {};
let currentBtn = null;
let currentTower = document.getElementById("tower-select").value;

// Toast
function showToast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2000);}

// Fetch
async function fetchLightData(tower){
  try {
    const res = await fetch(`${WEB_APP_URL}?tower=${encodeURIComponent(tower)}`);
    const data = await res.json();
    if(!data.success) throw new Error(data.error||"Failed to load");
    showToast(`Loaded ${tower}`);
    return data.data;
  } catch(e){ showToast("Error loading data"); console.error(e); return {}; }
}

// Update
async function updateLightStatus(tower,floor,unit,value){
  try {
    const res = await fetch(WEB_APP_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({tower,floor,unit,value})
    });
    const data = await res.json();
    if(!data.success) throw new Error(data.error||"Update failed");
    showToast("Updated");
  } catch(e){ showToast("Update failed"); console.error(e); }
}

// Render
function renderLights(){
  const container = document.getElementById("building");
  container.innerHTML="";
  for(const floor of Object.keys(lightData)){
    const floorDiv = document.createElement("div"); floorDiv.className="floor";
    const floorName = document.createElement("div"); floorName.className="floor-name"; floorName.textContent="Floor "+floor;
    floorDiv.appendChild(floorName);
    const grid = document.createElement("div"); grid.className="unit-grid";

    ["PE","SE"].forEach(type=>{
      const btn = document.createElement("button"); btn.textContent=type;
      btn.className="unit-btn large "+(lightData[floor][type]==1?"on":"off");
      btn.onclick=()=>openModal(btn,floor,type); grid.appendChild(btn);
    });

    const spacer = document.createElement("div"); spacer.className="spacer"; grid.appendChild(spacer);

    for(let u=1; u<=UNIT_COUNT; u++){
      const btn = document.createElement("button"); btn.textContent=u;
      btn.className="unit-btn "+(lightData[floor][u]==1?"on":"off");
      btn.onclick=()=>openModal(btn,floor,u); grid.appendChild(btn);
    }

    floorDiv.appendChild(grid);
    container.appendChild(floorDiv);
  }
}

// Modal
function openModal(btn,floor,unit){ currentBtn={btn,floor,unit};
  let formattedID = (unit==="PE"||unit==="SE") ? `${floor}${unit}${currentTower.slice(-1)}` : `${floor}${unit.toString().padStart(2,'0')}${currentTower.slice(-1)}`;
  document.getElementById("modal-text").textContent=`Is ${formattedID} light OK or OUT?`;
  document.getElementById("modal").classList.add("show");
}
function closeModal(){ document.getElementById("modal").classList.remove("show"); currentBtn=null; }

async function saveStatus(value){
  if(!currentBtn) return;
  const {btn,floor,unit}=currentBtn;
  if(lightData[floor][unit]===value){ closeModal(); showToast("No changes made"); return; }
  await updateLightStatus(currentTower,floor,unit,value);
  lightData[floor][unit]=value;
  btn.className="unit-btn"+(btn.classList.contains("large")?" large":"")+" "+(value==1?"on":"off");
  closeModal();
}

document.getElementById("on-btn").onclick=()=>saveStatus(1);
document.getElementById("out-btn").onclick=()=>saveStatus(0);
document.getElementById("tower-select").addEventListener("change",loadTower);

// Load tower
async function loadTower(){
  currentTower=document.getElementById("tower-select").value;
  document.getElementById("page-title").textContent=`VS2 Residential Lights Status - ${currentTower}`;
  lightData = await fetchLightData(currentTower);
  renderLights();
}

window.onload=loadTower;
</script>

</body>
</html>
